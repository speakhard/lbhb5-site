<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Edit {{ ep.slug }}</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 24px; max-width: 980px; }
    label { display:block; font-weight: 600; margin: 14px 0 6px; }
    input, textarea { width: 100%; padding: 10px; font-size: 14px; box-sizing: border-box; }
    textarea { min-height: 120px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .actions { margin-top: 18px; display:flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    button { padding: 10px 14px; cursor: pointer; }
    .meta { color:#555; font-size: 13px; }
    code { background:#f2f2f2; padding:2px 6px; border-radius: 6px; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin: 14px 0; }
    .badges span { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; margin-right: 6px; background: #eee; }
    .ok { background: #d7ffd7 !important; }
    .no { background: #ffd7d7 !important; }
    .danger { background: #fff3cd; border: 1px solid #ffe69c; }
    .muted { color:#666; font-size: 13px; }
    .links { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .links a { text-decoration: none; }
    .links a:hover { text-decoration: underline; }
    .help { font-size: 13px; color: #555; line-height: 1.4; }
    .small { font-size: 12px; color: #666; }
    .preview {
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
      background: #fafafa;
      overflow: auto;
      max-height: 360px;
    }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* Flash messages (if you enable them in templates later) */
    .flash { padding: 10px 12px; border-radius: 10px; margin: 12px 0; }
    .flash.ok { background: #e7fff0; border: 1px solid #b7f5cc; }
    .flash.error { background: #fff1f1; border: 1px solid #ffd0d0; }
  </style>
</head>
<body>
  <p><a href="{{ url_for('index') }}">← Back</a></p>

  <h1>Edit episode</h1>

  <div class="meta">
    <div><strong>Slug:</strong> <code>{{ ep.slug }}</code></div>
    <div><strong>Date:</strong> {{ ep.date }}</div>
  </div>

  <!-- Publish (Build + Git Commit + Push) -->
  <div class="card">
    <h2 style="margin:0 0 10px;">Publish</h2>

    <div class="help">
      This will run <span class="mono">python3 build.py</span>, then <span class="mono">git add -A</span>,
      commit (if there are changes), and <span class="mono">git push</span>.
    </div>

    <form method="post" action="{{ url_for('publish') }}" class="actions">
      <input
        name="message"
        placeholder='Commit message (optional, e.g. "Episode {{ ep.slug }} updates")'
        value="Publish updates"
      />
      <button type="submit">Publish</button>
      <a class="meta" href="{{ url_for('publish_log') }}">View publish log</a>
      <a class="meta" href="{{ url_for('build_log') }}">View build log</a>
    </form>

    <div class="muted">
      If Publish fails, it will be in the log (common causes: SSH auth not set up, no upstream, merge conflict).
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Transcript (this episode)</h2>

    <div class="badges meta" style="margin-bottom:10px;">
      <span class="{{ 'ok' if t.raw else 'no' }}">raw {{ '✓' if t.raw else '—' }}</span>
      <span class="{{ 'ok' if t.html else 'no' }}">html {{ '✓' if t.html else '—' }}</span>
      <span class="{{ 'ok' if t.md else 'no' }}">md {{ '✓' if t.md else '—' }}</span>
      <span class="{{ 'ok' if t.pdf else 'no' }}">pdf {{ '✓' if t.pdf else '—' }}</span>
    </div>

    <div class="muted" style="margin-bottom:10px;">
      Expected raw filename: <code>raw_transcripts/{{ ep.slug }}.txt</code>
    </div>

    <form method="post" action="{{ url_for('upload_transcript_for_episode', slug=ep.slug) }}" enctype="multipart/form-data" class="actions">
      <input type="file" name="file" accept=".txt" />
      <button type="submit">Upload raw transcript for this episode</button>
    </form>

    <div class="actions">
      <form method="post" action="{{ url_for('clean_transcript_for_episode', slug=ep.slug) }}">
        <button type="submit">Clean transcript for this episode</button>
      </form>

      <div class="links meta">
        {% if t.html %}
          <a href="/transcripts/{{ ep.slug }}.html" target="_blank" rel="noopener">Open HTML</a>
        {% endif %}
        {% if t.md %}
          <a href="/transcripts/{{ ep.slug }}.md" target="_blank" rel="noopener">Open MD</a>
        {% endif %}
        {% if t.pdf %}
          <a href="/transcripts/{{ ep.slug }}.pdf" target="_blank" rel="noopener">Open PDF</a>
        {% endif %}
        <a href="{{ url_for('transcript_log') }}">View transcript log</a>
      </div>
    </div>

    <div class="card danger">
      <div class="muted">
        Note: “Clean transcript” will overwrite existing <code>transcripts/{{ ep.slug }}.html</code> and <code>.md</code>.
        It will then move the raw file into <code>processed_transcripts/</code>.
      </div>
    </div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">Episode metadata</h2>

    <form method="post">
      <label>Title</label>
      <input name="title" value="{{ data.title }}"/>

      <label>Full description (what shows on episode page)</label>
      <textarea name="description">{{ data.description }}</textarea>

      <div class="row">
        <div>
          <label>Apple URL (optional per-episode override)</label>
          <input name="apple_url" value="{{ data.apple_url }}"/>
        </div>
        <div>
          <label>Spotify URL (optional per-episode override)</label>
          <input name="spotify_url" value="{{ data.spotify_url }}"/>
        </div>
      </div>

      <label>YouTube URL (optional)</label>
      <input name="youtube_url" value="{{ data.youtube_url }}"/>

      <label>Links & references (one per line: <code>Label | URL</code>)</label>
      <textarea name="links_blob">{% for l in data.links %}{{ l.label }} | {{ l.url }}
{% endfor %}</textarea>

      <label>Bluesky embed HTML (optional)</label>
      <div class="help">
        Paste the Bluesky embed block (the <span class="mono">&lt;blockquote class="bluesky-embed" ...&gt;...&lt;/blockquote&gt;</span> chunk).
        <div class="small" style="margin-top:6px;">
          Your profile: <a href="https://bsky.app/profile/lastbesthopeb5.bsky.social" target="_blank" rel="noopener">lastbesthopeb5.bsky.social</a>
        </div>
      </div>
      <textarea
        name="bluesky_embed_html"
        placeholder='Paste Bluesky embed HTML here (blockquote...)'
      >{{ data.bluesky_embed_html }}</textarea>

      {% if data.bluesky_embed_html %}
        <div class="muted" style="margin-top:10px;">Preview (basic sanity check):</div>
        <div class="preview">
          {{ data.bluesky_embed_html | safe }}
        </div>
      {% endif %}

      <div class="actions">
        <button type="submit">Save</button>
        <span class="meta">Saved to <code>episodes_meta/{{ ep.slug }}.json</code></span>
      </div>
    </form>
  </div>
</body>
</html>
