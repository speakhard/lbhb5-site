{% extends "base.html" %}

{% block content %}

<main class="episode-page">

  <article class="episode-page-shell">

    <header class="episode-page-header">
      <div class="episode-page-meta">
        <p class="episode-page-date">{{ episode.date }}</p>

        <h1 class="episode-page-title">{{ episode.title }}</h1>

        <div class="episode-page-actions">
          {% if episode.audio_url %}
            <a href="#episode-audio-player" class="btn btn-primary">‚ñ∂ Play episode</a>
          {% endif %}

          {% if site.apple_podcasts_url %}
            <a href="{{ site.apple_podcasts_url }}" class="btn btn-ghost" target="_blank" rel="noopener">Ô£ø Apple Podcasts</a>
          {% endif %}
          {% if site.spotify_url %}
            <a href="{{ site.spotify_url }}" class="btn btn-ghost" target="_blank" rel="noopener">‚ô´ Spotify</a>
          {% endif %}
          {% if site.rss_url %}
            <a href="{{ site.rss_url }}" class="btn btn-ghost" target="_blank" rel="noopener">RSS feed</a>
          {% endif %}
          {% if site.youtube_url %}
            <a href="{{ site.youtube_url }}" class="btn btn-ghost" target="_blank" rel="noopener">‚ñ∂ YouTube</a>
          {% endif %}
        </div>

        {% if episode.permalink %}
          <p class="episode-page-permalink">
            Original episode page:
            <a href="{{ episode.permalink }}" target="_blank" rel="noopener">{{ episode.permalink }}</a>
          </p>
        {% endif %}
      </div>

      {% if episode.image %}
        <div class="episode-page-art-wrap">
          <img src="{{ episode.image }}" alt="{{ episode.title }}" class="episode-page-art">
        </div>
      {% endif %}
    </header>

    <section class="episode-page-body">

      {% if episode.audio_url %}
        <section class="episode-player" id="episode-audio-player">
          <h2 class="section-heading">Listen</h2>
          <audio controls preload="none" class="episode-audio">
            <source src="{{ episode.audio_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        </section>
      {% endif %}

      {# FULL DESCRIPTION ONLY (no redundant ‚ÄúEpisode Summary‚Äù header) #}
      {% if episode.description %}
        <section class="episode-description">
          <div class="episode-description-body">
            {{ episode.description }}
          </div>
        </section>
      {% endif %}

      <!-- Transcript -->
      <section class="episode-transcript">
        <div class="episode-transcript-header">
          <h2 class="section-heading">Transcript</h2>

          {% if episode.transcript_html %}
            <div class="transcript-controls">
              <button
                type="button"
                class="btn btn-ghost btn-xs"
                id="toggle-timecodes"
                aria-pressed="false">
                Show timecodes
              </button>

              <a href="/transcripts/{{ episode.slug }}.html" class="btn btn-ghost btn-xs" target="_blank" rel="noopener">
                Open full transcript
              </a>
            </div>
          {% endif %}
        </div>

        {% if episode.transcript_html %}
          {# 
            Scrollable window.
            Default: timestamps hidden via .hide-timestamps on the wrapper.
            IMPORTANT: CSS must include:
              .episode-transcript-scroll { max-height: 420px; overflow: auto; }
              .episode-transcript-scroll.hide-timestamps .tc { display: none; }
          #}
          <div id="transcript-scroll" class="episode-transcript-scroll hide-timestamps">
            {{ episode.transcript_html | safe }}
          </div>

          <div class="transcript-links">
            <a href="/transcripts/{{ episode.slug }}.md" class="link-muted">Download as Markdown</a>
            <span aria-hidden="true">¬∑</span>
            <a href="/transcripts/{{ episode.slug }}.pdf" class="link-muted">Download as PDF</a>
          </div>
        {% else %}
          <p class="episode-transcript-empty">Transcript coming soon.</p>
        {% endif %}
      </section>

      <!-- Links & References -->
      <section class="episode-links">
        <h2 class="section-heading">Links & References</h2>

        {% if episode.links and episode.links|length %}
          <ul class="episode-links-list">
            {% for link in episode.links %}
              {% if link.url %}
                <li>
                  <a href="{{ link.url }}" target="_blank" rel="noopener">
                    {{ link.label if link.label else link.url }}
                  </a>
                </li>
              {% endif %}
            {% endfor %}
          </ul>
        {% else %}
          <p class="link-muted">No links added yet.</p>
        {% endif %}
      </section>

      <!-- Discussion -->
      <section class="episode-discussion">
        <h2 class="section-heading">Discuss this Episode</h2>

        {% if episode.bluesky_embed_html %}
          <div class="bluesky-embed-wrap">
            {{ episode.bluesky_embed_html | safe }}
          </div>
        {% endif %}

        <p class="episode-discussion-copy">Join the conversation with other listeners:</p>

        <div class="episode-discussion-actions">
          {% if site.mastodon_base_url %}
            <a href="{{ site.mastodon_base_url }}" class="btn btn-ghost" target="_blank" rel="noopener">üí¨ Thread on Mastodon</a>
          {% endif %}
          {% if site.reddit_thread_base %}
            <a href="{{ site.reddit_thread_base }}" class="btn btn-ghost" target="_blank" rel="noopener">‚¨ÜÔ∏è Thread on Reddit</a>
          {% endif %}
        </div>

        <p class="episode-discussion-note">
          (Best practice: keep discussion on a community platform rather than embedding heavy third-party trackers.)
        </p>
      </section>

    </section>
  </article>
</main>

<!-- Timecode toggle -->
<script>
  (function () {
    const scroll = document.getElementById('transcript-scroll');
    const btn = document.getElementById('toggle-timecodes');
    if (!scroll || !btn) return;

    // default: hidden (class present)
    btn.textContent = 'Show timecodes';
    btn.setAttribute('aria-pressed', 'false');

    btn.addEventListener('click', function () {
      const hiddenNow = scroll.classList.toggle('hide-timestamps');
      btn.textContent = hiddenNow ? 'Show timecodes' : 'Hide timecodes';
      btn.setAttribute('aria-pressed', hiddenNow ? 'false' : 'true');
    });
  })();
</script>

{% endblock %}
