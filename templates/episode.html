{% extends "base.html" %}

{% block content %}

<main class="episode-page">

  <!-- Episode hero card (same ‚Äúhull‚Äù look as index cards, but wider) -->
  <article class="episode-page-shell">

    <header class="episode-page-header">
      <div class="episode-page-meta">
        <p class="episode-page-date">{{ episode.date }}</p>

        <h1 class="episode-page-title">
          {{ episode.title }}
        </h1>

        {% if episode.description %}
          <p class="episode-page-dek">
            {{ episode.description }}
          </p>
        {% endif %}

        <!-- Primary actions: play + platform links -->
        <div class="episode-page-actions">
          {% if episode.audio_url %}
            <a href="#episode-audio-player" class="btn btn-primary">
              ‚ñ∂ Play episode
            </a>
          {% endif %}

          {% if site.apple_podcasts_url %}
            <a href="{{ site.apple_podcasts_url }}" class="btn btn-ghost" target="_blank" rel="noopener">
              Ô£ø Apple Podcasts
            </a>
          {% endif %}
          {% if site.spotify_url %}
            <a href="{{ site.spotify_url }}" class="btn btn-ghost" target="_blank" rel="noopener">
              ‚ô´ Spotify
            </a>
          {% endif %}
          {% if site.rss_url %}
            <a href="{{ site.rss_url }}" class="btn btn-ghost" target="_blank" rel="noopener">
              RSS feed
            </a>
          {% endif %}
          {% if site.youtube_url %}
            <a href="{{ site.youtube_url }}" class="btn btn-ghost" target="_blank" rel="noopener">
              ‚ñ∂ YouTube
            </a>
          {% endif %}
        </div>

        {% if episode.permalink %}
          <p class="episode-page-permalink">
            Original episode page:
            <a href="{{ episode.permalink }}" target="_blank" rel="noopener">
              {{ episode.permalink }}
            </a>
          </p>
        {% endif %}
      </div>

      {% if episode.image %}
        <div class="episode-page-art-wrap">
          <img src="{{ episode.image }}" alt="{{ episode.title }}" class="episode-page-art">
        </div>
      {% endif %}
    </header>

    <section class="episode-page-body">
      {% if episode.audio_url %}
        <section class="episode-player" id="episode-audio-player">
          <h2 class="section-heading">Listen</h2>
          <audio controls preload="none" class="episode-audio">
            <source src="{{ episode.audio_url }}" type="audio/mpeg">
            Your browser does not support the audio element.
          </audio>
        </section>
      {% endif %}

      <section class="episode-description">
        <h2 class="section-heading">Episode Summary</h2>
        {% if episode.description %}
          <p>{{ episode.description }}</p>
        {% else %}
          <p>No description available for this episode yet.</p>
        {% endif %}
      </section>

      <!-- Transcript -->
      <section class="episode-transcript">
        <div class="episode-transcript-header">
          <h2 class="section-heading">Transcript</h2>

          {% if episode.transcript_html %}
            <div class="transcript-controls">
              <button
                type="button"
                class="btn btn-ghost btn-xs"
                id="toggle-timecodes">
                Hide timecodes
              </button>
            </div>
          {% endif %}
        </div>

        {% if episode.transcript_html %}
          <!-- 
            transcript-body + hide-timestamps:
            - CSS: .transcript-body.hide-timestamps .tc { display: none; }
            - Default: hide timestamps; button toggles this class.
          -->
          <div id="transcript-panel" class="transcript-body hide-timestamps">
            {{ episode.transcript_html | safe }}
          </div>

          <div class="transcript-links">
            <a href="/transcripts/{{ episode.slug }}.html" class="link-muted" target="_blank" rel="noopener">
              Open full transcript in a new tab
            </a>
            <span aria-hidden="true">¬∑</span>
            <a href="/transcripts/{{ episode.slug }}.md" class="link-muted">
              Download as Markdown
            </a>
            <span aria-hidden="true">¬∑</span>
            <a href="/transcripts/{{ episode.slug }}.pdf" class="link-muted">
              Download as PDF
            </a>
          </div>
        {% else %}
          <p class="episode-transcript-empty">
            Transcript coming soon.
          </p>
        {% endif %}
      </section>

      <!-- Relevant links section -->
      <section class="episode-links">
        <h2 class="section-heading">Links & References</h2>
        <ul class="episode-links-list">
          {# TODO: wire real per-episode links later #}
          <li><a href="#">Example article about Babylon 5 politics</a></li>
          <li><a href="#">Interview or essay mentioned in the episode</a></li>
        </ul>
      </section>

      <!-- Comment / discussion strategy: link out rather than embed heavy widget -->
      <section class="episode-discussion">
        <h2 class="section-heading">Discuss this Episode</h2>
        <p class="episode-discussion-copy">
          Join the conversation with other listeners:
        </p>
        <div class="episode-discussion-actions">
          {% if site.mastodon_base_url %}
            <a href="{{ site.mastodon_base_url }}" class="btn btn-ghost" target="_blank" rel="noopener">
              üí¨ Thread on Mastodon
            </a>
          {% endif %}
          {% if site.reddit_thread_base %}
            <a href="{{ site.reddit_thread_base }}" class="btn btn-ghost" target="_blank" rel="noopener">
              ‚¨ÜÔ∏è Thread on Reddit
            </a>
          {% endif %}
        </div>
        <p class="episode-discussion-note">
          (Best practice in 2025 is to keep comments on a federated or community
          platform you control, rather than embedding heavy third-party trackers.)
        </p>
      </section>

    </section>
  </article>
</main>

<!-- Tiny inline script for timecode toggle -->
<script>
  (function () {
    const panel = document.getElementById('transcript-panel');
    const btn = document.getElementById('toggle-timecodes');
    if (!panel || !btn) return;

    // Start with timestamps hidden (class present)
    // Clicking toggles visibility and label text.
    btn.addEventListener('click', function () {
      const nowHidden = panel.classList.toggle('hide-timestamps');
      btn.textContent = nowHidden ? 'Show timecodes' : 'Hide timecodes';
    });
  })();
</script>

{% endblock %}
